import{E as D,a as I}from"./EmittersPlugin-DqHY-4Vm.js";import{F as l,o as d,G as x,d as C,r as A,ak as z,aj as L,N as B,ah as T,i as G}from"./index-CU4cAu28.js";import"./AnimatableColor-CgZOQjVR.js";import"./AnimationOptions-SbnIf2Gg.js";import"./OptionsColor-CXhukRcf.js";const g=.5,v=0,m=0,P=0,M=0,q=-1,V=1;function S(u,t){u.color?u.color.value=t:u.color={value:t}}class K{constructor(t,i,n,c,a){var o,_;this.emitters=i,this.container=n,this._destroy=()=>{var s,p;(s=this._mutationObserver)==null||s.disconnect(),this._mutationObserver=void 0,(p=this._resizeObserver)==null||p.disconnect(),this._resizeObserver=void 0,this.emitters.removeEmitter(this),this._engine.dispatchEvent("emitterDestroyed",{container:this.container,data:{emitter:this}})},this._prepareToDie=()=>{var f;if(this._paused)return;const s=((f=this.options.life)==null?void 0:f.duration)!==void 0?l(this.options.life.duration):void 0;this.container.retina.reduceFactor&&(this._lifeCount>0||this._immortal)&&s!==void 0&&s>0&&(this._duration=s*d)},this._setColorAnimation=(s,p,y,f=V)=>{const w=this.container;if(!s.enable)return p;const E=x(s.offset),O=l(this.options.rate.delay),b=O*d/w.retina.reduceFactor,F=0,R=l(s.speed??F);return(p+R*w.fpsLimit/b+E*f)%y},this._engine=t,this._currentDuration=0,this._currentEmitDelay=0,this._currentSpawnDelay=0,this._initialPosition=a,c instanceof D?this.options=c:(this.options=new D,this.options.load(c)),this._spawnDelay=l(this.options.life.delay??v)*d/this.container.retina.reduceFactor,this.position=this._initialPosition??this._calcPosition(),this.name=this.options.name,this.fill=this.options.fill,this._firstSpawn=!this.options.life.wait,this._startParticlesAdded=!1;let r=C({},this.options.particles);if(r??(r={}),r.move??(r.move={}),(o=r.move).direction??(o.direction=this.options.direction),this.options.spawnColor&&(this.spawnColor=A(this.options.spawnColor)),this._paused=!this.options.autoPlay,this._particlesOptions=r,this._size=this._calcSize(),this.size=z(this._size,this.container.canvas.size),this._lifeCount=this.options.life.count??q,this._immortal=this._lifeCount<=m,this.options.domId){const s=document.getElementById(this.options.domId);s&&(this._mutationObserver=new MutationObserver(()=>{this.resize()}),this._resizeObserver=new ResizeObserver(()=>{this.resize()}),this._mutationObserver.observe(s,{attributes:!0,attributeFilter:["style","width","height"]}),this._resizeObserver.observe(s))}const h=this.options.shape,e=(_=this._engine.emitterShapeManager)==null?void 0:_.getShapeGenerator(h.type);e&&(this._shape=e.generate(this.position,this.size,this.fill,h.options)),this._engine.dispatchEvent("emitterCreated",{container:n,data:{emitter:this}}),this.play()}externalPause(){this._paused=!0,this.pause()}externalPlay(){this._paused=!1,this.play()}async init(){var t;await((t=this._shape)==null?void 0:t.init())}pause(){this._paused||delete this._emitDelay}play(){if(!this._paused&&this.container.retina.reduceFactor&&(this._lifeCount>m||this._immortal||!this.options.life.count)&&(this._firstSpawn||this._currentSpawnDelay>=(this._spawnDelay??P))){if(this._emitDelay===void 0){const t=l(this.options.rate.delay);this._emitDelay=t*d/this.container.retina.reduceFactor}(this._lifeCount>m||this._immortal)&&this._prepareToDie()}}resize(){var i;const t=this._initialPosition;this.position=t&&L(t,this.container.canvas.size,B.origin)?t:this._calcPosition(),this._size=this._calcSize(),this.size=z(this._size,this.container.canvas.size),(i=this._shape)==null||i.resize(this.position,this.size)}update(t){var i;this._paused||(this._firstSpawn&&(this._firstSpawn=!1,this._currentSpawnDelay=this._spawnDelay??P,this._currentEmitDelay=this._emitDelay??M),this._startParticlesAdded||(this._startParticlesAdded=!0,this._emitParticles(this.options.startCount)),this._duration!==void 0&&(this._currentDuration+=t.value,this._currentDuration>=this._duration&&(this.pause(),this._spawnDelay!==void 0&&delete this._spawnDelay,this._immortal||this._lifeCount--,this._lifeCount>m||this._immortal?(this.position=this._calcPosition(),(i=this._shape)==null||i.resize(this.position,this.size),this._spawnDelay=l(this.options.life.delay??v)*d/this.container.retina.reduceFactor):this._destroy(),this._currentDuration-=this._duration,delete this._duration)),this._spawnDelay!==void 0&&(this._currentSpawnDelay+=t.value,this._currentSpawnDelay>=this._spawnDelay&&(this._engine.dispatchEvent("emitterPlay",{container:this.container}),this.play(),this._currentSpawnDelay-=this._currentSpawnDelay,delete this._spawnDelay)),this._emitDelay!==void 0&&(this._currentEmitDelay+=t.value,this._currentEmitDelay>=this._emitDelay&&(this._emit(),this._currentEmitDelay-=this._emitDelay)))}_calcPosition(){if(this.options.domId){const t=document.getElementById(this.options.domId);if(t){const i=t.getBoundingClientRect(),n=this.container.retina.pixelRatio;return{x:(i.x+i.width*g)*n,y:(i.y+i.height*g)*n}}}return T({size:this.container.canvas.size,position:this.options.position})}_calcSize(){const t=this.container;if(this.options.domId){const i=document.getElementById(this.options.domId);if(i){const n=i.getBoundingClientRect();return{width:n.width*t.retina.pixelRatio,height:n.height*t.retina.pixelRatio,mode:"precise"}}}return this.options.size??(()=>{const i=new I;return i.load({height:0,mode:"percent",width:0}),i})()}_emit(){if(this._paused)return;const t=l(this.options.rate.quantity);this._emitParticles(t)}_emitParticles(t){var n;const i=G(this._particlesOptions);for(let c=0;c<t;c++){const a=C({},i);if(this.spawnColor){const e=(n=this.options.spawnColor)==null?void 0:n.animation;if(e){const o={h:360,s:100,l:100},_=3.6;this.spawnColor.h=this._setColorAnimation(e.h,this.spawnColor.h,o.h,_),this.spawnColor.s=this._setColorAnimation(e.s,this.spawnColor.s,o.s),this.spawnColor.l=this._setColorAnimation(e.l,this.spawnColor.l,o.l)}S(a,this.spawnColor)}const r=this.options.shape;let h=this.position;if(this._shape){const e=this._shape.randomPosition();if(e){h=e.position;const o=r.replace;o.color&&e.color&&S(a,e.color),o.opacity&&(a.opacity?a.opacity.value=e.opacity:a.opacity={value:e.opacity})}else h=null}h&&this.container.particles.addParticle(h,a)}}}export{K as EmitterInstance};
